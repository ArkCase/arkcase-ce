- name: configure Mongodb 4.0 repository
  become: yes
  copy:
    dest: /etc/yum.repos.d/mongodb-org.repo
    force: no
    content: |
      [mongodb-org-4.0]
      name=MongoDB Repository
      baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/4.0/x86_64/
      gpgcheck=1
      enabled=1
      gpgkey=https://www.mongodb.org/static/pgp/server-4.0.asc

- name: install Mongodb
  become: yes
  yum:
    state: installed
    disable_gpg_check: yes
    name:
      - mongodb-org
  register: mongodb_install

- name: ensure Mongodb is started
  become: yes
  systemd:
    name: mongod
    state: started

- name: ensure Mongodb is stopped
  become: yes
  systemd:
    name: mongod
    state: stopped

- name: Mongodb data and log folder structure
  become: yes
  file:
    path: "{{ item.name }}"
    state: directory
    group: mongod
    owner: mongod
    setype: "{{ item.setype }}"
  loop:
    - name: "{{ root_folder }}/data/mongo"
    #SELinux context on the new dbpath
      setype: "mongod_var_lib_t"
    - name: "{{ root_folder }}/log/mongodb"
    #SELinux context on the new logpath
      setype: "mongod_log_t"
  register: mongodb_folder_structure
  
- name: Mongodb config
  become: yes
  backup: yes
  template:
    src: templates/mongod.conf
    dest: /etc/mongod.conf

#Ansible check if file existis in order to not replace the existing data files with the default ones.
- name: ansible check if file exists on a specific path
  stat:
    path: '{{ mongodb_data_folder }}/mongod.lock'
  register: p

- name: copy data
  become: yes
  command: "cp -rp /var/lib/mongo/* {{ mongodb_data_folder }}"
  when: p.stat.exists == True

- name: enable Mongodb to start on boot
  become: yes
  systemd:
    name: mongod
    enabled: yes
    masked: no

- name: ensure Mongodb is started
  become: yes
  systemd:
    name: mongod
    state: started