- name: add {{ u.user_id }} user
  ldap_entry:
    server_uri: ldaps://{{ arkcase_host_name }}:636
    validate_certs: no
    bind_dn: CN=Administrator,CN=Users,{{ ldap_base }}
    bind_pw: "{{ samba_admin_password }}"
    dn: CN={{ u.user_id }},OU=Users,OU=ArkCase,{{ ldap_base }}
    objectClass:
      - organizationalPerson
      - person
      - user
      - top
    attributes:
      # note, Samba doesn't let you set memberOf directory, you
      # have to create the user, then add them to the group.
      description: "{{ u.description }}"
      samAccountName: "{{ u.user_id }}"
      name: "{{ u.name }}"
      mail: "{{ u.mail }}"
      givenName: "{{ u.firstName }}"
      sn: "{{ u.lastName }}"
      cn: "{{ u.user_id }}"
  register: new_user 

- name: set {{ u.user_id }} password
  block:
    - name: base64 encode password
      shell: echo -n '"{{ u.password }}"' | iconv -f utf8 -t utf16le | base64 -w 0
      register: base64_password
      changed_when: false
    - name: copy change password ldif file
      become: yes
      copy:
        content: |
          dn: CN={{ u.user_id }},OU=Users,OU=ArkCase,{{ ldap_base }}
          changetype: modify
          replace: unicodePwd
          unicodePwd:: {{ base64_password.stdout }}
        dest: /opt/install/samba/password_change.ldif
    - name: execute password change
      shell: LDAPTLS_REQCERT=never ldapmodify -H ldaps://{{ arkcase_host_name }} -D CN=Administrator,CN=Users,{{ ldap_base }} -w {{ samba_admin_password }} -x -f /opt/install/samba/password_change.ldif
  when: new_user is changed

- name: enable {{ u.user_id }} account
  block:
    - name: copy enable user ldif file
      become: yes
      copy:
        content: |
          dn: CN={{ u.user_id }},OU=Users,OU=ArkCase,{{ ldap_base }}
          changetype: modify
          replace: userAccountControl
          userAccountControl: 512
        dest: /opt/install/samba/activate_user.ldif
    - name: execute password change
      shell: LDAPTLS_REQCERT=never ldapmodify -H ldaps://{{ arkcase_host_name }} -D CN=Administrator,CN=Users,{{ ldap_base }} -w {{ samba_admin_password }} -x -f /opt/install/samba/activate_user.ldif
  when: new_user is changed
      
- name: store user id
  set_fact: 
    user_id: "{{ u.user_id }}"

- name: add {{ u.user_id }} account to groups
  include_tasks: add-user-to-group.yml
  loop: "{{ u.groups }}"

- name: see if password is non-expiring already
  shell: /opt/app/samba/bin/pdbedit -Lv {{ u.user_id }} | grep "Account Flags"
  register: account_flags
  changed_when: false

- name: set password to never expire
  command: /opt/app/samba/bin/samba-tool user setexpiry {{ u.user_id }} --noexpiry
  when: u.nonexpiring_password and 'X' not in account_flags.stdout
