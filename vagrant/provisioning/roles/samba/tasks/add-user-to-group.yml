- name: find {{ user_id }} group memberships
  shell: LDAPTLS_REQCERT=never ldapsearch -H ldaps://{{ arkcase_host_name }} -b {{ ldap_base }} -D CN=Administrator,CN=Users,{{ ldap_base }} -w {{ samba_admin_password }} -x samAccountName={{ user_id }}
  register: group_memberships
  changed_when: false
- name: compute membership token
  set_fact:
    member_to_check: "memberOf: CN={{ item }},OU=Groups,OU=ArkCase,{{ ldap_base}}"
- name: copy add-user-to-group ldif file
  become: yes
  copy:
    content: |
      dn: CN={{ item }},OU=Groups,OU=ArkCase,{{ ldap_base }}
      changetype: modify
      add: member
      member: CN={{ user_id }},OU=Users,OU=ArkCase,{{ ldap_base }}
    dest: /opt/install/samba/add_user_to_group.ldif
  when: "member_to_check not in group_memberships.stdout"
- name: execute add user to group
  shell: LDAPTLS_REQCERT=never ldapmodify -H ldaps://{{ arkcase_host_name }} -D CN=Administrator,CN=Users,{{ ldap_base }} -w {{ samba_admin_password }} -x -f /opt/install/samba/add_user_to_group.ldif
  when: "member_to_check not in group_memberships.stdout"
