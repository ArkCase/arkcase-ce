- name: python LDAP package (RHEL 8)
  set_fact:
    pkg_python_ldap: python3-ldap
  when: ansible_distribution == "RedHat" and ansible_distribution_major_version == "8"

- name: python LDAP package (CentOS 7)
  set_fact:
    pkg_python_ldap: python-ldap
  when: ansible_distribution == "CentOS" and ansible_distribution_major_version == "7"

- name: LDAP required packages
  become: yes
  yum:
    state: installed
    name: 
      - openldap-clients
      - "{{ pkg_python_ldap }}"

- name: install cryptography
  become: yes
  pip:
    executable: pip3
    name: cryptography

- name: read LDAP server cert
  community.crypto.get_certificate:
    host: "{{ ldap_host }}"
    port: "{{ ldap_port }}"
  register: ldap_server_cert

- name: write LDAP server cert to trusted cert store
  become: yes
  copy:
    dest: /etc/pki/ca-trust/source/ldap_server_cert.pem
    content: "{{ ldap_server_cert.cert }}"
    backup: true
    force: yes
  register: ldap_server_cert_pem

- name: update trusted certs
  become: yes
  command: update-ca-trust
  when: ldap_server_cert_pem is changed

- name: add arkcase ancestors
  ldap_entry:
    server_uri: "{{ ldap_url }}"
    validate_certs: no
    bind_dn: "{{ ldap_bind_user }}"
    bind_pw: "{{ ldap_bind_password }}"
    dn: "{{ item }}"
    objectClass:
      - organizationalUnit
      - top
    attributes:
      description: "{{ item }}"
  loop: "{{ ldap_ancestor_ous }}"

- name: add arkcase organizational units
  ldap_entry:
    server_uri: "{{ ldap_url }}"
    validate_certs: no
    bind_dn: "{{ ldap_bind_user }}"
    bind_pw: "{{ ldap_bind_password }}"
    dn: "{{ item }}"
    objectClass:
      - organizationalUnit
      - top
    attributes:
      description: "{{ item }}"
  loop:
    - "{{ ldap_group_base }}"
    - "{{ ldap_user_base }}"

- name: add portal organizational units
  ldap_entry:
    server_uri: "{{ ldap_url }}"
    validate_certs: no
    bind_dn: "{{ ldap_bind_user }}"
    bind_pw: "{{ ldap_bind_password }}"
    dn: "{{ item }}"
    objectClass:
      - organizationalUnit
      - top
    attributes:
      description: "{{ item }}"
  loop:
    - "{{ ldap_portal_group_no_base }},{{ ldap_base }}"
    - "{{ ldap_portal_user_no_base }},{{ ldap_base }}"
  when: foia_portal_context is defined

- name: add arkcase groups
  ldap_entry:
    server_uri: "{{ ldap_url }}"
    validate_certs: no
    bind_dn: "{{ ldap_bind_user }}"
    bind_pw: "{{ ldap_bind_password }}"
    dn: "CN={{ item.name }},{{ldap_group_base}}"
    objectClass:
      - group
      - top
    attributes:
      description: "{{ item.description }}"
      samAccountName: "{{ item.name }}"
      cn: "{{ item.name }}"
  loop: "{{ ldap_groups|flatten }}"

- name: remove portal group from ArkCase OU if exists
  ldap_entry:
    server_uri: "{{ ldap_url }}"
    validate_certs: no
    bind_dn: "{{ ldap_bind_user }}"
    bind_pw: "{{ ldap_bind_password }}"
    dn: "CN={{ item.name }},{{ ldap_group_no_base }},{{ ldap_base }}"
    state: absent
    objectClass:
      - group
      - top
    attributes:
      description: "{{ item.description }}"
      samAccountName: "{{ item.name }}"
      cn: "{{ item.name }}"
  loop: "{{ ldap_portal_groups|flatten }}"
  when: foia_portal_context is defined

- name: add portal groups
  ldap_entry:
    server_uri: "{{ ldap_url }}"
    validate_certs: no
    bind_dn: "{{ ldap_bind_user }}"
    bind_pw: "{{ ldap_bind_password }}"
    dn: "CN={{ item.name }},{{ ldap_portal_group_no_base }},{{ ldap_base }}"
    objectClass:
      - group
      - top
    attributes:
      description: "{{ item.description }}"
      samAccountName: "{{ item.name }}"
      cn: "{{ item.name }}"
  loop: "{{ ldap_portal_groups|flatten }}"  
  when: foia_portal_context is defined

- name: add users
  include_tasks: add-user.yml
  loop: "{{ ldap_users }}"    
  loop_control:
    loop_var: u 

- name: Make sure Samba passwords never expire
  become: yes
  command: '{{ root_folder }}/app/samba/bin/samba-tool domain passwordsettings set --max-pwd-age=0'
  when: ldap_type == "samba" and internal_host == ldap_host

