---

- name: install pyOpenSSL
  become: yes
  pip:
    name: pyOpenSSL

- name: create pki folder structure
  become: yes
  file:
    path: "{{ item }}"
    state: directory
  with_items:
    - /etc/ssl/private
    - /etc/ssl/csr
    - /etc/ssl/crt
    - /etc/ssl/ca

# Generate an OpenSSL private key with the default values (4096 bits, RSA)
- name: generate root private key
  become: yes
  openssl_privatekey:
    path: /etc/ssl/private/acm-arkcase-root.pem

- name: root csr
  become: yes
  openssl_csr:
    path: /etc/ssl/csr/acm-arkcase.root.csr
    privatekey_path: /etc/ssl/private/acm-arkcase-root.pem
    basic_constraints: "CA:true"
    basic_constraints_critical: true
    locality_name: Vienna
    state_or_province_name: VA
    country_name: US
    organization_name: ArkCase
    organizational_unit_name: Product Development
    email_address: info@arkcase.com
    common_name: ArkCase Root Certification Authority L0
    key_usage:
      - digitalSignature
      - cRLSign
      - keyCertSign
    key_usage_critical: true
  register: root_csr

- name: Sign root CSR
  become: yes
  openssl_certificate:
    path: /etc/ssl/ca/acm-arkcase.root.crt
    privatekey_path: /etc/ssl/private/acm-arkcase-root.pem
    csr_path: /etc/ssl/csr/acm-arkcase.root.csr
    provider: selfsigned
  when: root_csr is changed

- name: generate intermediate private key
  become: yes
  openssl_privatekey:
    path: /etc/ssl/private/acm-arkcase-intermediate.pem

- name: intermediate csr
  become: yes
  openssl_csr:
    path: /etc/ssl/csr/acm-arkcase.intermediate.csr
    privatekey_path: /etc/ssl/private/acm-arkcase-intermediate.pem
    basic_constraints: "CA:true, pathlen:0"
    locality_name: Vienna
    state_or_province_name: VA
    country_name: US
    organization_name: ArkCase
    organizational_unit_name: Product Development
    email_address: info@arkcase.com
    common_name: ArkCase Intermediate Certification Authority L1
    key_usage:
      - cRLSign
      - digitalSignature
      - keyCertSign
    key_usage_critical: true
  register: intermediate_csr

- name: Sign intermediate CSR
  become: yes
  openssl_certificate:
    path: /etc/ssl/ca/acm-arkcase.intermediate.crt
    privatekey_path: /etc/ssl/private/acm-arkcase-root.pem
    csr_path: /etc/ssl/csr/acm-arkcase.intermediate.csr
    provider: selfsigned
    extended_key_usage: v3_ca_int
  when: intermediate_csr is changed

- name: generate server private key
  become: yes
  openssl_privatekey:
    path: /etc/ssl/private/acm-arkcase.pem

- name: server csr
  become: yes
  openssl_csr:
    path: /etc/ssl/csr/acm-arkcase.csr
    privatekey_path: /etc/ssl/private/acm-arkcase.pem
    basic_constraints: "CA:false"
    locality_name: Vienna
    state_or_province_name: VA
    country_name: US
    organization_name: ArkCase
    organizational_unit_name: Product Development
    email_address: info@arkcase.com
    common_name: acm-arkcase
    key_usage:
      - digitalSignature
      - keyEncipherment
    key_usage_critical: true
    extended_key_usage:
      - serverAuth
  register: server_csr

- name: Sign server CSR
  become: yes
  openssl_certificate:
    path: /etc/ssl/crt/acm-arkcase.crt
    privatekey_path: /etc/ssl/private/acm-arkcase-intermediate.pem
    csr_path: /etc/ssl/csr/acm-arkcase.csr
    provider: selfsigned
    extended_key_usage: server_cert
  when: server_csr is changed
  

- name: write server private key in RSA format, for MySQL et. al.
  become: yes
  command: openssl rsa -in /etc/ssl/private/acm-arkcase.pem -out /etc/ssl/private/acm-arkcase.rsa.pem
  when: server_csr is changed
  
  
