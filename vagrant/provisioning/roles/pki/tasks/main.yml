---

- name: install pyOpenSSL
  become: yes
  pip:
    name: pyOpenSSL

- name: create pki folder structure
  become: yes
  file:
    path: "{{ item }}"
    state: directory
  with_items:
    - /etc/ssl/private
    - /etc/ssl/csr
    - /etc/ssl/crt
    - /etc/ssl/ca

# Generate an OpenSSL private key with the default values (4096 bits, RSA)
- name: generate ca private key
  become: yes
  openssl_privatekey:
    path: /etc/ssl/private/arkcase-ca.pem

- name: generate ca certificate
  become: yes
  openssl_csr:
    path: /etc/ssl/csr/arkcase-ca.csr
    privatekey_path: /etc/ssl/private/arkcase-ca.pem
    country_name: US
    state_or_province_name: Virginia
    locality_name: Vienna
    organization_name: ArkCase
    organizational_unit_name: Product Development
    common_name: ArkCase Root Certification Authority L0
    email_address: info@arkcase.com
  register: ca_csr

- name: Sign ca certificate
  become: yes
  openssl_certificate:
    path: /etc/ssl/ca/arkcase-ca.crt
    privatekey_path: /etc/ssl/private/arkcase-ca.pem
    csr_path: /etc/ssl/csr/arkcase-ca.csr
    provider: selfsigned
  when: ca_csr is changed

- name: generate server private key
  become: yes
  openssl_privatekey:
    path: /etc/ssl/private/acm-arkcase.pem

- name: server csr
  become: yes
  openssl_csr:
    path: /etc/ssl/csr/acm-arkcase.csr
    privatekey_path: /etc/ssl/private/acm-arkcase.pem
    country_name: US
    state_or_province_name: VA
    locality_name: Vienna
    organization_name: ArkCase
    organizational_unit_name: Product Development
    email_address: info@arkcase.com
    common_name: acm-arkcase
  register: server_csr

- name: Sign server CSR
  become: yes
  openssl_certificate:
    path: /etc/ssl/crt/acm-arkcase.crt
    privatekey_path: /etc/ssl/private/arkcase-ca.pem
    csr_path: /etc/ssl/csr/acm-arkcase.csr
    provider: selfsigned
  when: server_csr is changed
  
- name: write server private key in RSA format, for MySQL et. al.
  become: yes
  command: openssl rsa -in /etc/ssl/private/acm-arkcase.pem -out /etc/ssl/private/acm-arkcase.rsa.pem
  when: server_csr is changed

- name: sign the server certificate
  become: yes
  command: openssl x509 -req -in /etc/ssl/csr/acm-arkcase.csr -CA /etc/ssl/ca/arkcase-ca.crt -CAkey /etc/ssl/private/arkcase-ca.pem -set_serial 01 -out /etc/ssl/ca/acm-arkcase.cert.pem
  when: server_csr is changed


- name: client private key
  become: yes
  openssl_privatekey:
    path: /etc/ssl/private/acm-arkcase-client.pem

- name: client csr
  become: yes
  openssl_csr:
    path: /etc/ssl/csr/acm-arkcase-client.csr
    privatekey_path: /etc/ssl/private/acm-arkcase-client.pem
    country_name: US
    state_or_province_name: VA
    locality_name: Vienna
    organization_name: ArkCase
    organizational_unit_name: Product Development
    email_address: info@arkcase.com
    common_name: acm-arkcase-client
  register: client_csr
    
- name: Sign client CSR
  become: yes
  openssl_certificate:
    path: /etc/ssl/crt/acm-arkcase-client.crt
    privatekey_path: /etc/ssl/private/arkcase-ca.pem
    csr_path: /etc/ssl/csr/acm-arkcase-client.csr
    provider: selfsigned
  when: client_csr is changed
    
- name: write client private key in RSA format, for MySQL et. al.
  become: yes
  command: openssl rsa -in /etc/ssl/private/acm-arkcase-client.pem -out /etc/ssl/private/acm-arkcase-client.rsa.pem
  when: client_csr is changed

- name: sign the client certificate
  become: yes
  command: openssl x509 -req -in /etc/ssl/csr/acm-arkcase-client.csr -CA /etc/ssl/ca/arkcase-ca.crt -CAkey /etc/ssl/private/arkcase-ca.pem -set_serial 02 -out /etc/ssl/ca/acm-arkcase-client.cert.pem
  when: client_csr is changed

- name: add client cert to Java keystore
  become: yes
  java_cert:
    cert_alias: arkcase_client
    cert_path: /etc/ssl/ca/acm-arkcase-client.cert.pem
    keystore_path: /usr/lib/jvm/java-1.8.0-openjdk/jre/lib/security/cacerts
    keystore_pass: changeit
    state: present
    
  
  
