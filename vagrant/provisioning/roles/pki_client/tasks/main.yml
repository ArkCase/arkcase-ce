- name: install cryptography
  become: yes
  pip:
    executable: pip3
    name: cryptography

- name: see if rsa private key exists
  stat:
    path: "{{ ssl_key_rsa }}"
  register: ssl_key_rsa_stat

- name: write server private key in RSA format, for MySQL et. al. - no pass phrase
  become: yes
  command: openssl rsa -in {{ ssl_key }} -out {{ ssl_key_rsa }}
  when: not ssl_key_rsa_stat.stat.exists|bool and not ssl_key_passphrase is defined

- name: write server private key in RSA format, for MySQL et. al. - pass phrase
  become: yes
  command: openssl rsa -in {{ ssl_key }} -out {{ ssl_key_rsa }} -passin pass:'{{ ssl_key_passphrase }}'
  when: not ssl_key_rsa_stat.stat.exists|bool and ssl_key_passphrase is defined

- name: see if the Java keystore for Java11+ exists
  become: yes
  stat:
    path: "{{ java_p12_store }}"
  register: arkcase_ks_stat
  changed_when: false

- name: generate PKCS12 key store for Java 11+
  become: yes
  command: openssl pkcs12 -export -in {{ ssl_cert }} -inkey {{ ssl_key_rsa }} -out "{{ java_p12_store }}" -name arkcase_server -chain -CAfile {{ ssl_ca }} -certpbe AES-256-CBC -keypbe AES-256-CBC -macalg SHA512 -passout 'pass:{{ java_key_store_pass }}'
  when: not arkcase_ks_stat.stat.exists

- name: see if the Java keystore for Java8 exists
  become: yes
  stat:
    path: "{{ java_p12_store_jdk8 }}"
  register: arkcase_ks_jdk8_stat
  changed_when: false

- name: generate PKCS12 key store for Java 8
  become: yes
  command: openssl pkcs12 -export -in {{ ssl_cert }} -inkey {{ ssl_key_rsa }} -out "{{ java_p12_store_jdk8 }}" -name arkcase_server -chain -CAfile {{ ssl_ca }} -passout 'pass:{{ java_key_store_pass }}'
  when: not arkcase_ks_jdk8_stat.stat.exists

- name: ensure shared permissions on different TLS artifacts
  become: yes
  file:
    path: "{{ item }}"
    mode: 0644
  loop:
   - "{{ java_p12_store }}"
   - "{{ java_p12_store_jdk8 }}"
   - "{{ java_pem_store }}"
   - "{{ ssl_ca }}"
   - "{{ root_folder }}/common/rds-ca-2019-root.pem"

- name: ensure secure permissions on private keys
  become: yes
  file: 
    path: "{{ item }}"
    mode: 0600
  loop:
    - "{{ ssl_key }}"
    - "{{ ssl_key_rsa }}"

- name: call update-ca-trust, to generate the default OpenJDK trust store
  become: yes
  command: update-ca-trust

- name: write encrypted symmetric key file for use in ArkCase webapp
  block:
    - name: check if symmetric key file exists
      become: yes
      stat:
        path: "{{ root_folder }}/common/symmetricKey.encrypted"
      register: sym_key_enc
      changed_when: false
    - name: write plaintext key file, this will have a new line
      become: yes
      copy:
        dest: "{{ root_folder }}/common/symmetricKeyWithNewline.txt"
        content: |
          {{ 9999999999999999999999 | random | to_uuid }}
      when: sym_key_enc.stat.exists == False
      register: plaintext_with_newline
    - name: remove the trailing new line from the symmetric key file
      become: yes
      shell: tr -d '\n' <{{ root_folder }}/common/symmetricKeyWithNewline.txt > {{ root_folder }}/common/symmetricKey.txt
      when: plaintext_with_newline is changed
      register: trim_plaintext
    - name: remove the original plaintext that had the newline
      become: yes
      file:
        path: "{{ root_folder }}/common/symmetricKeyWithNewline.txt"
        state: absent
      when: trim_plaintext is changed
    - name: extract public key from server cert
      become: yes
      command: openssl x509 -pubkey -noout -in {{ ssl_cert }} -noout
      register: pub_key
      when: sym_key_enc.stat.exists == False
      changed_when: false
    - name: write public key to file
      become: yes
      copy:
        dest: "{{ root_folder }}/common/arkcase-server.pub"
        content: |
          {{ pub_key.stdout }}
      when: sym_key_enc.stat.exists == False
    - name: write encrypted plaintext
      become: yes
      command: openssl rsautl -encrypt -pubin -inkey "{{ root_folder }}/common/arkcase-server.pub" -in "{{ root_folder }}/common/symmetricKey.txt" -out "{{ root_folder }}/common/symmetricKey.encrypted"
      when: sym_key_enc.stat.exists == False


