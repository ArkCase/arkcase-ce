- name: detect current Tomcat version
  become: yes
  shell: "{{ root_folder}}/app/pentaho/pentaho-server/tomcat/bin/version.sh | grep 'Server version' | awk -F/ '{ print $2 }'"
  register: current_version
- name: copy current version to backup location, if different from desired version
  become: yes
  shell: cp -a {{ root_folder}}/app/pentaho/pentaho-server/tomcat {{ root_folder}}/app/pentaho/pentaho-server/tomcat-{{ current_version.stdout }}
  when: pentaho_tomcat_version != current_version.stdout
- name: zip/archive the backup location, if needed
  become: yes
  shell: zip -rm {{ root_folder}}/app/pentaho/pentaho-server/tomcat-{{ current_version.stdout }}.zip {{ root_folder}}/app/pentaho/pentaho-server/tomcat-{{ current_version.stdout }}
  when: pentaho_tomcat_version != current_version.stdout
- include_tasks: "{{ role_path }}/../common/tasks/download.yml"
  loop:
    - name: Tomcat
      dest: "{{ root_folder }}/common/apache-tomcat-{{ pentaho_tomcat_version }}.tar.gz"
      owner: root
      url: https://archive.apache.org/dist/tomcat/tomcat-{{ pentaho_tomcat_version[0] }}/v{{ pentaho_tomcat_version }}/bin/apache-tomcat-{{ pentaho_tomcat_version }}.tar.gz
  when: pentaho_tomcat_version != current_version.stdout
- name: make new tomcat home folder, if new version is an upgrade
  become: yes
  file:
    path: "{{ root_folder}}/app/pentaho/pentaho-server/tomcat-{{ pentaho_tomcat_version }}"
    state: directory
    group: "pentaho"
    owner: "pentaho"
    mode: 0755
  when: pentaho_tomcat_version != current_version.stdout
- name: unarchive upgrade Tomcat
  become: yes
  become_user: "pentaho"
  unarchive:
    src: "{{ root_folder }}/common/apache-tomcat-{{ pentaho_tomcat_version }}.tar.gz"
    remote_src: yes
    dest: "{{ root_folder}}/app/pentaho/pentaho-server/tomcat-{{ pentaho_tomcat_version }}"
    extra_opts:
      - --strip-components=1
    creates: "{{ root_folder}}/app/pentaho/pentaho-server/tomcat-{{ pentaho_tomcat_version }}/README.md"
  when: pentaho_tomcat_version != current_version.stdout
- name: apply upgraded files
  become: yes
  become_user: "pentaho"
  shell: cp -vprf {{ root_folder}}/app/pentaho/pentaho-server/tomcat-{{ pentaho_tomcat_version }}/{lib,bin,BUILDING.txt,CONTRIBUTING.md,LICENSE,NOTICE,README.md,RELEASE-NOTES,RUNNING.txt} {{ root_folder}}/app/pentaho/pentaho-server/tomcat
  when: pentaho_tomcat_version != current_version.stdout
- name: remove the extra Tomcat folder
  become: yes
  become_user: pentaho
  shell: rm -rf {{ root_folder}}/app/pentaho/pentaho-server/tomcat-{{ pentaho_tomcat_version }}
  when: pentaho_tomcat_version != current_version.stdout

- name: link JDBC jar file
  become: yes
  become_user: pentaho
  file:
    src: "{{ root_folder }}/common/{{ jdbc_driver_jar_filename }}"
    dest: "{{ root_folder}}/app/pentaho/pentaho-server/tomcat/lib/{{ jdbc_driver_jar_filename }}"
    state: link

- name: LDAP application context
  become: yes
  become_user: pentaho
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  loop:
    - src: "applicationContext-security-ldap.properties"
      dest: "{{ root_folder }}/app/pentaho/pentaho-server/pentaho-solutions/system/applicationContext-security-ldap.properties"
    - src: "repository.spring.properties"
      dest: "{{ root_folder }}/app/pentaho/pentaho-server/pentaho-solutions/system/repository.spring.properties"

- name: install prerequisites to build native library
  become: yes
  yum:
    state: present
    name:
      - "@Development Tools"
      - openssl-devel
      - apr-devel
- name: copy private key for Pentaho
  become: yes
  copy:
    remote_src: yes
    src: "{{ ssl_key }}"
    dest: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/conf/pentaho.key"
    owner: "pentaho"
    group: "pentaho"
    mode: 0600
- name: create folder for native library build
  become: yes
  become_user: "pentaho"
  file:
    path: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/bin/native"
    state: directory
- name: unarchive Tomcat native library
  become: yes
  become_user: "pentaho"
  unarchive:
    src: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/bin/tomcat-native.tar.gz"
    remote_src: yes
    dest: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/bin/native"
    extra_opts:
      - --strip-components=1
    creates: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/bin/native/README.txt"
- name: build Tomcat native library
  become: yes
  become_user: "pentaho"
  shell: ./configure --with-apr=/usr/bin/apr-1-config --with-java-home=/usr/lib/jvm/java --with-ssl=yes --prefix={{ root_folder }}/app/pentaho/pentaho-server/tomcat
  args:
    chdir: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/bin/native/native"
    creates: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/bin/native/native/config.log"
- name: make
  become: yes
  become_user: "pentaho"
  command: make
  args:
    chdir: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/bin/native/native"
    creates: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/bin/native/native/.libs/libtcnative-1.so"
- name: make install
  become: yes
  become_user: "pentaho"
  command: make install
  args:
    chdir: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/bin/native/native"
    creates: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/lib/libtcnative-1.so"

- name: jmx config files
  become: yes
  become_user: pentaho
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode }}"
    backup: yes
  loop:
    - src: "access.file"
      mode: "0644"
      dest: "{{ root_folder }}/app/pentaho"
    - src: "password.file"
      mode: "0600"
      dest: "{{ root_folder }}/app/pentaho"

- name: tomcat config files
  become: yes
  become_user: pentaho
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode }}"
    backup: yes
  loop:
    - src: "setenv.sh"
      mode: "u+x"
      dest: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/bin"
    - src: "server.xml"
      mode: "0644"
      dest: "{{ root_folder}}/app/pentaho/pentaho-server/tomcat/conf"

- name: read current import-export script
  become: yes
  become_user: pentaho
  command: cat {{ root_folder }}/app/pentaho/pentaho-server/import-export.sh
  register: import_export
  changed_when: false
  
- name: set TLS options in import-export script
  become: yes
  become_user: pentaho
  replace:
    path: "{{ root_folder }}/app/pentaho/pentaho-server/import-export.sh"
    regexp: "-Xmx2048m"
    replace: "-Djavax.net.ssl.trustStorePassword={{ java_trust_store_pass }} -Djavax.net.ssl.trustStore={{ java_trust_store}} -Xmx2048m"
  when: "'Djavax.net.ssl.trustStorePassword' not in import_export.stdout"

- name: configure Tomcat log file locations
  become: yes
  become_user: pentaho
  replace:
    path: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/conf/logging.properties"
    backup: yes
    regexp: '\$\{catalina\.base\}\/logs'
    replace: "{{ root_folder }}/log/pentaho"

- name: configure Pentaho log file locations
  become: yes
  become_user: pentaho
  replace:
    path: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/WEB-INF/classes/log4j.xml"
    backup: yes
    regexp: '\.\.\/logs\/'
    replace: "{{ root_folder }}/log/pentaho/"

- name: pentaho logrotate
  become: yes
  template:
    src: "templates/pentaho"
    dest: /etc/logrotate.d/pentaho

- name: database configuration templates
  become: yes
  become_user: pentaho
  template:
    backup: yes
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  loop:
    - src: "repository.xml"
      dest: "{{ root_folder }}/app/pentaho/pentaho-server/pentaho-solutions/system/jackrabbit/repository.xml"
    - src: "quartz.properties"
      dest: "{{ root_folder }}/app/pentaho/pentaho-server/pentaho-solutions/system/quartz/"
    - src: "hibernate-settings.xml"
      dest: "{{ root_folder }}/app/pentaho/pentaho-server/pentaho-solutions/system/hibernate/"
    - src: "activemq.xml"
      dest: "{{ root_folder }}/app/pentaho/pentaho-server/pentaho-solutions/system/karaf/etc/"

- name: hibernate template (postgresql only)
  become: yes
  become_user: pentaho
  template:
    backup: yes
    src: applicationContext-security-hibernate_postgresql.properties
    dest: "{{ root_folder }}/app/pentaho/pentaho-server/pentaho-solutions/system/dialects/postgresql/applicationContext-spring-security-hibernate.properties"
  when: db_engine == 'postgresql'

- name: copy audit_sql.xml (local file)
  become: yes
  become_user: pentaho
  copy:
    backup: yes
    remote_src: yes
    src: "{{ root_folder }}/app/pentaho/pentaho-server/pentaho-solutions/system/dialects/{{ (db_engine == 'postgresql') | ternary('postgresql', 'mysql5') }}/audit_sql.xml"
    dest: "{{ root_folder }}/app/pentaho/pentaho-server/pentaho-solutions/system/audit_sql.xml"

- name: add resource-refs to web.xml
  become: yes
  become_user: pentaho
  blockinfile:
    backup: yes
    path: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/WEB-INF/web.xml"
    insertafter: "insert additional resource-refs"
    marker: "<!-- {mark} ANSIBLE MANAGED RESOURCE REFS -->"
    content: |
      <resource-ref>
        <description>acm3DataSource</description>
        <res-ref-name>jdbc/acm3DataSource</res-ref-name>
        <res-type>javax.sql.DataSource</res-type>
        <res-auth>Container</res-auth>
      </resource-ref>

- name: preauthentication setup
  become: yes
  become_user: pentaho
  copy:
    backup: yes
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  loop:
    - src: "arkcase-preauth-springsec-v4-1.1.1-bundled.jar"
      dest: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/WEB-INF/lib/"
    - src: "applicationContext-spring-security.xml"
      dest: "{{ root_folder }}/app/pentaho/pentaho-server/pentaho-solutions/system/"
    - src: "arkcase-preauth.xml"
      dest: "{{ root_folder }}/app/pentaho/pentaho-server/pentaho-solutions/system/"

#- name: Update Pentaho to support report designer within ArkCase iframe
#  copy:
#    src: "{{ item.src }}"
#    dest: "{{ item.dest }}"
#    mode: preserve
#    remote_src: true
#  loop:
#    - src: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/home/properties/"
#      dest: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle"
#    - src: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/home/properties"
#      dest: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle"
#    - src: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/home/content"
#      dest: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle"
#    - src: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/home/css"
#      dest: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle"
#    - src: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/home/js"
#      dest: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle"
#    - src: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/home/images/"
#      dest: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle"
#    - src: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/browser/lib"
#      dest: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle"
#    - src: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/browser/css/browser.css"
#      dest: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/css/"
#    - src: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/browser/"
#      dest: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle"

- name: Update Pentaho to support report designer within ArkCase iframe
  shell: "{{ item }}" 
  become: yes
  become_user: pentaho
  with_items:
    - cp -p {{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/home/properties/* {{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/
    - cp -rp {{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/home/properties {{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/
    - cp -rp {{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/home/content {{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/
    - cp -rp {{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/home/css {{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/
    - cp -rp {{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/home/js {{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/
    - cp -p {{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/home/images/* {{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/images/
    - cp -rp {{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/browser/lib {{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/
    - cp -p {{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/browser/css/browser.css {{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/css/
    - cp -prf {{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/browser/* {{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/

- name: Replace modernizr
  become: yes
  become_user: pentaho
  lineinfile:
    path: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/content/welcome/index.html"
    regexp: '<script src="..\/..\/..\/..\/plugin\/pentaho-cdf\/api\/resources\/js\/compressed\/lib\/modernizr\/modernizr-2.8.3.js" charset="utf-8"><\/script>'
    line: '<script src="../../../plugin/pentaho-cdf/api/resources/js/compressed/lib/modernizr/modernizr-2.8.3.js" charset="utf-8"></script>'
    state: present
    backup: yes

- name: Replace jquery
  become: yes
  become_user: pentaho
  lineinfile:
    path: "{{ root_folder }}/app/pentaho/pentaho-server/tomcat/webapps/pentaho/mantle/content/welcome/index.html"
    regexp: '<script src="..\/..\/..\/..\/content\/common-ui\/resources\/web\/compressed\/jquery\/jquery.js" charset="utf-8"><\/script>'
    line: '<script src="../../../content/common-ui/resources/web/compressed/jquery/jquery.js" charset="utf-8"></script>'
    state: present
    backup: yes

- name: set Pentaho script SELinux context
  become: yes
  file:
    path: "{{ item }}"
    setype: bin_t
  loop:
    - "{{ root_folder }}/app/pentaho/pentaho-server/start-pentaho.sh"
    - "{{ root_folder }}/app/pentaho/pentaho-server/stop-pentaho.sh"

# Pentaho needs to start once with the default jackrabbit-based security (not with LDAP); this initial startup will create tenant0. After that, change the security provider to ldap restart
- name: Pentaho systemd unit file (local database)
  become: yes
  template:
    src: "pentaho.service"
    dest: /etc/systemd/system/pentaho.service
  when: not rds_password is defined
  register: pentaho_systemd

- name: Pentaho systemd unit file (RDS)
  become: yes
  template:
    src: "pentaho-rds.service"
    dest: /etc/systemd/system/pentaho.service
  when: rds_password is defined
  register: pentaho_systemd

- name: reload daemon-files if needed
  become: yes
  command: systemctl daemon-reload
  when: pentaho_systemd is changed
  
- name: enable Pentaho to start on boot
  become: yes
  systemd:
    daemon_reload: true
    name: pentaho
    enabled: yes
    masked: no

- name: start Pentaho, if not already started
  become: yes
  systemd:
    name: pentaho
    state: started

- name: wait for Pentaho port to be available
  wait_for:
    port: 2002
    delay: 5
    timeout: 300

## pentaho will redirect to the external host which 
## probably isn't working yet, so we will not follow 
## redirects, and count success when we get a 302
- name: wait for Pentaho webapp to really be available
  uri:
    url: https://localhost:2002/pentaho
    validate_certs: false
    follow_redirects: none
    status_code: [ 200, 302, 404 ]
  register: _result
  until: _result.status == 302
  retries: 30
  delay: 5
  ignore_errors: yes

- name: restart pentaho if status code 404
  become: yes
  systemd:
    name: pentaho
    state: restarted
  when: _result.status == 404  

- name: wait for Pentaho port to be available
  wait_for:
    port: 2002
    delay: 5
    timeout: 300
  when: _result.status == 404

- name: wait for Pentaho webapp to really be available
  uri:
    url: https://localhost:2002/pentaho
    validate_certs: false
    follow_redirects: none
    status_code: [ 200, 302, 404 ]
  register: _result
  until: _result.status == 302
  retries: 30
  delay: 5
  when: _result.status == 404  

- name: ensure ldap security is being used
  become: yes
  become_user: pentaho
  replace:
    path: "{{ root_folder }}/app/pentaho/pentaho-server/pentaho-solutions/system/security.properties"
    regexp: jackrabbit
    replace: ldap
  register: security_provider_updated
    
- name: Fix loader not closing issue
  become: yes
  become_user: pentaho
  replace:
    backup: yes
    path: "{{ root_folder }}/app/pentaho/pentaho-server/pentaho-solutions/system/reporting/reportviewer/compressed/reportviewer-app.js"
    regexp: 'l\&\&l.className\&\&l'
    replace: 'l&&l'
    
- name: restart pentaho
  become: yes
  systemd:
    name: pentaho
    state: restarted
  
- name: wait for pentaho to come back, if it was restarted
  wait_for:
    port: 2002
    delay: 5
    timeout: 300
  when: security_provider_updated is changed

## pentaho will redirect to the external host which 
## probably isn't working yet, so we will not follow 
## redirects, and count success when we get a 302
- name: wait for Pentaho webapp to really be available
  uri:
    url: https://localhost:2002/pentaho
    validate_certs: false
    follow_redirects: none
    status_code: [ 200, 302, 404 ]
  register: _result
  until: _result.status == 302
  retries: 100
  delay: 5
  when: security_provider_updated is changed

- name: Expose pentaho app port
  become: yes
  firewalld:
    port: "2002/tcp"
    permanent: yes
    immediate: yes
    state: enabled

- name: format extension version
  set_fact:
    arkcase_extension_version_formatted: "{{ '-' ~ arkcase_extension_version if arkcase_extension_version != '' else '' }}"

- name: download extension (if configured)
  become: yes
  become_user: pentaho
  command: sshpass -e sftp -o StrictHostKeyChecking\=no -o UserKnownHostsFile\=/dev/null {{ sftp_extension_user }}@{{ sftp_service_base_url }}:{{ sftp_extension_folder }}/{{ arkcase_extension_id }}{{ arkcase_extension_version_formatted }}.jar
  args:
    chdir: "{{ root_folder }}/install/pentaho"
  environment:
    SSHPASS: "{{ sftp_extension_password }}"
  when: arkcase_retrieve_strategy == "sftp" and arkcase_extension_install|bool

- name: deploy extension reports
  include_tasks: deploy_extension_report.yml
  loop: "{{ arkcase_extension_reports|flatten }}"
  when: arkcase_extension_install_reports|bool
  loop_control:
    loop_var: r
