- name: update startup script
  become: yes
  become_user: solr
  replace:
    path: /opt/app/solr/bin/init.d/solr
    regexp: "{{ item.regexp }}"
    replace: "{{ item.replace }}"
  loop:
    - regexp: "/opt/solr"
      replace: "/opt/app/solr"
    - regexp: "/etc/default/solr.in.sh"
      replace: "/opt/app/solr/bin/solr.in.sh"

- name: update environment file - basics
  become: yes
  become_user: solr
  blockinfile:
    path: /opt/app/solr/bin/solr.in.sh
    insertbefore: EOF
    marker: "# {mark} ANSIBLE MANAGED BLOCK - BASICS"
    block: |
      SOLR_OPTS="$SOLR_OPTS -Dsolr.autoSoftCommit.maxTime=1000 -Dsolr.jetty.host=0.0.0.0 -Djava.net.preferIPv4Stack=true"
      SOLR_DATA_HOME=/opt/data/solr
      SOLR_LOGS_DIR=/opt/log/solr
      SOLR_LOG_LEVEL=INFO
      SOLR_HOST=arkcase-ce.local

- name: update environment file - jmx enabled
  become: yes
  become_user: solr
  blockinfile:
    path: /opt/app/solr/bin/solr.in.sh
    insertbefore: EOF
    marker: "# {mark} ANSIBLE MANAGED BLOCK - JMX"
    block: |
      SOLR_OPTS="$SOLR_OPTS -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only=false -Dcom.sun.management.jmxremote.ssl=true -Dcom.sun.management.jmxremote.authenticate=true -Dcom.sun.management.jmxremote.port=50502 -Dcom.sun.management.jmxremote.rmi.port=50503 -Dcom.sun.management.jmxremote.access.file=/opt/app/solr/access.file -Dcom.sun.management.jmxremote.password.file=/opt/app/solr/password.file -Djava.rmi.server.hostname=arkcase-ce.local"
  when: solr_jmx_enabled

- name: update environment file - TLS
  become: yes
  become_user: solr
  blockinfile:
    path: /opt/app/solr/bin/solr.in.sh
    insertbefore: EOF
    marker: "# {mark} ANSIBLE MANAGED BLOCK - TLS"
    block: |
      SOLR_SSL_ENABLED=true
      SOLR_SSL_KEY_STORE=/opt/common/arkcase.ks
      SOLR_SSL_KEY_STORE_PASSWORD=password
      SOLR_SSL_TRUST_STORE=/opt/common/arkcase.ts
      SOLR_SSL_TRUST_STORE_PASSWORD=password
      SOLR_SSL_TRUST_STORE_TYPE=JKS
      SOLR_SSL_NEED_CLIENT_AUTH=false
      SOLR_SSL_WANT_CLIENT_AUTH=false

- name: Solr systemd unit file
  become: yes
  copy:
    src: solr.service
    dest: /etc/systemd/system/solr.service
  register: systemd_solr_updated

- name: reload daemon files if needed
  become: yes
  command: systemctl daemon-reload
  when: systemd_solr_updated is changed
    
- name: enable Solr to start on boot
  become: yes
  systemd:
    name: solr
    enabled: yes
    masked: no

