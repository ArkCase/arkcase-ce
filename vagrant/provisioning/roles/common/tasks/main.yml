- name: set hostname
  become: yes
  hostname:
    name: "{{ arkcase_host_name }}"

- name: check for virtualbox guest additions
  stat: path=/usr/share/virtualbox/VBoxGuestAdditions_{{ virtualbox_version }}.iso
  register: virtualbox_guest_additions

- name: update all packages
  become: yes
  yum:
    name: '*'
    state: latest

# reboot check taken from https://www.jeffgeerling.com/blog/2018/reboot-and-wait-reboot-complete-ansible-playbook
- name: Check for reboot
  shell: if [ $(rpm -q kernel|tail -n 1) != kernel-$(uname -r) ]; then echo 'reboot'; else echo 'no'; fi
  ignore_errors: true
  register: reboot_hint
  changed_when: false

- name: rebuild guest additions if necessary
  import_tasks: "{{ role_path }}/../virtualbox/tasks/reinstall-guest-additions.yml"
  when: virtualbox_guest_additions.stat.exists == True and reboot_hint.stdout.find("reboot") != -1

- name: rebooting
  shell: "sleep 5 && reboot"
  async: 1
  poll: 0
  become: yes
  ignore_errors: true
  register: rebooting
  when: reboot_hint.stdout.find("reboot") != -1

- name: Wait for rebooted box to come back
  wait_for_connection:
    connect_timeout: 20
    sleep: 5
    delay: 5
    timeout: 300
  when: rebooting is changed
      
- name: install required packages
  become: yes
  yum:
    state: installed
    name: 
      - java-1.8.0-openjdk
      - java-1.8.0-openjdk-devel
      - policycoreutils-python
      - zip
      - unzip
      - git
      - net-tools
      - epel-release

# need to run another yum, AFTER installing epel-release, to get epel packages
- name: install epel packages
  become: yes
  yum:
    state: installed
    name: 
      - python-pip
    
- name: folder structure for app, data and logs
  become: yes
  file:
    path: "{{ item }}"
    state: directory
  with_items:
    - /opt
    - /opt/app
    - /opt/data
    - /opt/log
    - /opt/install
    - /opt/common
    - /opt/tmp

- name: add arkcase-ce.local to hosts file
  lineinfile:
    path: /etc/hosts
    line: "192.168.56.15 arkcase-ce.local"
    

