- name: deploy arkcase-file-utils
  include_tasks: "{{ role_path }}/../arkcase-microservice/tasks/deploy_microservice.yml"
  vars:
    microservice:
      name: arkcase-file-utils
      version: "{{ arkcase_file_utils_version | default(arkcase_version) }}"
      java_opts: "-Dserver.port=9078 -Xmx512M -Dspring.cloud.config.uri=https://{{ config_server_host | default(internal_host) }}/config -Dspring.profiles.include={{ arkcase_portal_extension ~ ',' if arkcase_portal_extension != '' else '' }}server,runtime -Djava.net.preferIPv4Stack=true -Djavax.net.ssl.trustStorePassword={{ java_trust_store_pass }} -Djavax.net.ssl.keyStore={{ java_p12_store_jdk8 }} -Djavax.net.ssl.trustStore={{ java_trust_store}} -Djavax.net.ssl.keyStorePassword={{ java_key_store_pass }} -Djodconverter.local.officeHome={{ libreoffice_install_path }} -Djodconverter.local.port-numbers=9079 -Dspring.kafka.bootstrap-servers={{ kafka_host | default(internal_host) }}:{{ kafka_port | default(9092) }} -Darkcase.kafka.bootstrapAddress={{ kafka_host | default(internal_host) }}:{{ kafka_port | default(9092) }} -Dspring.kafka.producer.bootstrap-servers={{ kafka_host | default(internal_host) }}:{{ kafka_port | default(9092) }} -Dspring.kafka.security.protocol=SSL"
      boot_opts: "--spring.config.location=classpath:/bootstrap.yaml,classpath:/application.yaml,{{ root_folder }}/app/arkcase-file-utils/server.yml"
      template: server.yml

- name: install LibreOffice (CentOS 7)
  become: yes
  yum:
    state: installed
    name:
      - libreoffice
  when: ansible_distribution == "CentOS" and ansible_distribution_major_version == "7"

- name: install LibreOffice (RHEL 8)
  block:
    - name: download LibreOffice 
      include_tasks: "{{ role_path }}/../common/tasks/download.yml"
      loop:
        - name: LibreOffice {{ libreoffice_version }}
          dest: "{{ root_folder }}/install/arkcase/LibreOffice_{{ libreoffice_version }}_Linux_x86-64_rpm.tar.gz"
          owner: arkcase
          url: https://downloadarchive.documentfoundation.org/libreoffice/old/{{ libreoffice_version }}/rpm/x86_64/LibreOffice_{{ libreoffice_version }}_Linux_x86-64_rpm.tar.gz
    - name: unarchive libreoffice
      become: yes
      become_user: arkcase
      unarchive:
        src: "{{ root_folder }}/install/arkcase/LibreOffice_{{ libreoffice_version }}_Linux_x86-64_rpm.tar.gz"
        remote_src: yes
        dest: "{{ root_folder }}/install/arkcase"
        creates: "{{ root_folder }}/install/arkcase/LibreOffice_{{ libreoffice_version }}_Linux_x86-64_rpm/readmes/README_en-US"
    - name: install libreoffice
      become: yes
      # because the RPMs aren't signed properly for FIPS mode, we need to disable digest checking.
      shell: rpm -Uvh --nodigest --nofiledigest {{ root_folder }}/install/arkcase/LibreOffice_{{ libreoffice_version }}_Linux_x86-64_rpm/RPMS/*.rpm
      args:
        warn: false
      register: libreoffice_rpm_install
      failed_when: libreoffice_rpm_install.rc != 0 and "is already installed" not in libreoffice_rpm_install.stderr
      changed_when: libreoffice_rpm_install.rc == 0
  when: ansible_distribution == "RedHat" and ansible_distribution_major_version == "8"
