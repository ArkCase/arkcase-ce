- name: configure Mongodb 4.0 repository
  become: yes
  copy:
    dest: /etc/yum.repos.d/mongodb-org.repo
    force: no
    content: |
      [mongodb-org-4.0]
      name=MongoDB Repository
      baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/4.0/x86_64/
      gpgcheck=1
      enabled=1
      gpgkey=https://www.mongodb.org/static/pgp/server-4.0.asc

- name: install Mongodb
  become: yes
  yum:
    state: installed
    disable_gpg_check: yes
    name:
      - mongodb-org
  register: mongodb_install

- name: Mongodb folders
  become: yes
  file:
    path: "{{ item.name }}"
    state: directory
    group: mongod
    owner: mongod
    setype: "{{ item.setype }}"
  loop:
    - name: "{{ mongodb_data_folder }}"
    #SELinux context on the new dbpath
      setype: "mongod_var_lib_t"
    - name: "{{ mongodb_log_folder }}"
    #SELinux context on the new logpath
      setype: "mongod_log_t"
  register: mongodb_folder_structure

- name: Change path to the data folder
  become: yes
  replace: 
    path: /tmp/mongod.conf
    regexp: "dbPath:/var/lib/mongo"
    replace: "dbPath:/opt/arkcase/data/mongo"

- name: Change path to the log folder
  become: yes
  replace: 
    path: /tmp/mongod.conf
    regexp: "path:/var/log/mongodb/mongod.log"
    replace: "path:/opt/arkcase/log/mongodb/mongod.log"

#Ansible check if file existis in order to not replace the existing data files with the default ones.
- name: Ansible check file exists.
  stat:
    path: '{{ mongodb_data_folder }}/mongod.lock'
    register: p
- name: Check if file exists.  
  debug:
    msg: "File exists..."
  when: p.stat.exists

- name: copy data
  debug:
    msg: "File not found"
  become: yes
  command: cp -rp /var/lib/mongo/* {{ mongodb_data_folder }}
  when: p.stat.exists == False

- name: enable Mongodb to start on boot
  become: yes
  systemd:
    name: mongod
    enabled: yes
    masked: no

- name: ensure mongodb is started
  become: yes
  systemd:
    name: mongod
    state: started
